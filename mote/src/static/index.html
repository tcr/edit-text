<title>Mote</title>

<h1>mote editor <button id="sync">sync!</button></h1>
<script src="jquery.min.js"></script>

<style>
body {
  font-family: Helvetica;
}

h4 {
  margin-bottom: 0;
}

.mote {
  font-family: monospace;
  -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

.mote div {
  /*border: 1px solid #444;*/
  background: rgba(0, 0, 0, .15);
  padding: 12px 12px 12px 16px;
  margin: 8px 0;
  position: relative;
  min-height: 14px;
}

.mote div.active > div {
  background: #ccc;
}

.mote div::before {
  display: block;
  content: attr(data-tag);
  opacity: 0.5;
  background: black;
  color: white;
  padding: 2px 4px;
  width: -webkit-max-content;
  margin-bottom: 6px;
  text-align: center;
}

.mote * {
  clear: both;
}

button {
  font: inherit;
  font-size: 0.6em;
}

.mote span {
  background: rgb(100, 200, 100);
  padding: 3px 5px;
  /*border: 1px solid rgba(0, 0, 0, .3);*/
  display: inline-block;
  width: 20px;
  height: 1.8em;
  box-sizing: border-box;
  margin-left: 1px;
  margin-bottom: 2px;
  cursor: pointer;
  white-space: pre;
}

.mote span:hover {
  -webkit-filter: brightness(150%);
}

.mote .active {
  background: #98e;
}

.mote span.active,
.mote span.target {
  border-right: 3px solid rgba(0, 0, 0, .3);
  margin-right: -1px;
  width: 21px;
}

.mote div.active, .mote div.target {
  border-bottom: 3px solid rgba(0, 0, 0, .3);
  padding-bottom: 9px;
}

.mote div[data-tag="b"],
.mote div[data-tag="i"] {
  display: inline-block;
  margin-left: 1px;
  padding: 4px 4px 1px;
}

.mote div[data-tag="b"]::before,
.mote div[data-tag="i"]::before {
  float: left;
  margin-top: 2px; 
  margin-right: 2px;
}

.mote .active ~ * {
  background: red;
}

.mote .target ~ span {
  background: rgb(100, 200, 100);
}

.mote .target ~ div {
  background: rgba(0, 0, 0, .15);
}

</style>

<h4>Client 1</h4>
<div class="mote" id="mote-1"></div>

<h4>Client 2</h4>
<div class="mote" id="mote-2"></div>

<script>

function load (el) {
  // TODO act like doc
  var h = $('<div>').attr('data-tag', el.fields[0].tag);
  for (var i = 0; i < el.fields[1].length; i++) {
    if (el.fields[1][i].variant == 'DocChars') {
      for (var j = 0; j < el.fields[1][i].fields[0].length; j++) {
        h.append($('<span>').text(el.fields[1][i].fields[0][j]));
      }
    } else {
      h.append(load(el.fields[1][i]));
    }
  }
  return h;
}

function navto (el, then) {
  var p = el.parents('.mote');
  var cur = [then];
  while (!el.is(p)) {
    if (el.prevAll().length > 0) {
      cur.unshift({
        "variant": "AddSkip",
        "fields": [el.prevAll().length]
      });
    }
    el = el.parent();
    if (el.is(p)) {
      break;
    }
    cur = [{
      "variant": "AddWithGroup",
      "fields": [cur],
    }];
  }
  return cur;
}

function delto (el, then) {
  var p = el.parents('.mote');
  var cur = [then];
  while (!el.is(p)) {
    if (el.prevAll().length > 0) {
      cur.unshift({
        "variant": "DelSkip",
        "fields": [el.prevAll().length],
      });
    }
    el = el.parent();
    if (el.is(p)) {
      break;
    }
    cur = [{
      "variant": "DelWithGroup",
      "fields": [cur],
    }];
  }
  return cur;
}

function init (m) {

  function serialize (parent) {
    if (!parent) {
      parent = m[0];
    }
    var out = []
    $(parent).children().each(function () {
      if ($(this).is('div')) {
        out.push({
          "variant": 'DocGroup',
          "fields": [{"tag": $(this).attr('data-tag')}, serialize(this)],
        });
      } else {
        var txt = this.innerText
        if ((out[out.length - 1] || {}).variant == 'DocChars') {
          txt = out.pop().fields[0] + txt;
        }
        out.push({
          "variant": 'DocChars',
          "fields": [txt]
        });
      }
    })
    return out;
  }

  function getActive() {
    var a = $('.active')
    return a[0] ? a : null;
  }

  function getTarget() {
    var a = $('.active')
    return a[0] ? a : null;
  }

  function isBlock ($active) {
    return $active && $active[0].tagName == 'DIV'
  }

  function isChar ($active) {
    return $active && $active[0].tagName == 'SPAN'
  }

  function clearActive () {
    $(document).find('.active').removeClass('active');
  }

  function clearTarget () {
    $(document).find('.target').removeClass('target');
  }

  m.on('click', 'span, div', function (e) {
    var active = getActive();
    var target = getTarget();

    if (e.shiftKey) {
      if (active && active.nextAll().add(active).is(this)) {
        clearTarget();
        $(this).addClass('target');
      }
    } else {
      clearActive();
      clearTarget();
      $(this).addClass('active').addClass('target')
      active = $(this);
    }
    return false;
  })

  $(document).on('keypress', function (e) {
    var active = getActive();
    var target = getTarget();

    if (active && !active.parents('.mote').is(m)) {
      return
    }

    if (e.keyCode == 13) {
      return;
    }

    var txt = String.fromCharCode(e.keyCode);
    var span = $('<span>').text(txt).addClass('active').addClass('target');
    if (isBlock(active)) {
      clearActive();
      clearTarget();
      active.prepend(span);
      active = span;

      op([], navto(active,
        {
          "variant": "AddChars",
          "fields": [txt]
        }
      ));
    } else if (isChar(active)) {
      clearActive();
      clearTarget();
      span.insertAfter(active);
      active = span;

      op([], navto(active,
        {
          "variant": "AddChars",
          "fields": [txt]
        }
      ));
    }
  })

  var ophistory = []

  function op (d, a) {
    ophistory.push([d, a]);
    // console.log(JSON.stringify(j));
    setTimeout(function () {
      var match = serialize();
      // test
      var packet = [
        ophistory,
        match
      ];
      
      $.ajax('/api/confirm', {
        data : JSON.stringify(packet),
        contentType : 'application/json',
        type : 'POST',
      })
      .done(function () {
        console.log('success', arguments);
      })
      .fail(function () {
        console.log('failure', arguments);
      });
    })
  }

  $(document).on('keydown', function (e) {
    var active = getActive();
    var target = getTarget();

    if (active && !active.parents('.mote').is(m)) {
      return
    }

    // enter
    // if (e.keyCode == 13) {
    //   if (active) {
    //     var tag = prompt("Tag name:", "p");
    //     if (tag) {
    //       var out = active.nextAll().add(active);
    //       var parent = active.parent();
    //       var newparent = $('<div>').attr('data-tag', tag).insertAfter(parent);
    //       newparent.append(out);
    //       // TODO what in OP form
    //     }
    //   }
    //   return false;
    // }

    // command+,
    if (e.keyCode == 188 && e.metaKey) {
      if (active) {
        var tag = prompt("Tag name:", "p");
        if (tag) {
          var out = active.nextAll().add(active).not($('.target').nextAll());
          clearActive();
          clearTarget();
          out.wrapAll($('<div>').attr('data-tag', tag));
          active = out.parent().addClass('active').addClass('target');
          op([], navto(active,
            {
              "variant": "AddGroup",
              "fields": [{"tag": tag}, [
                {
                  "variant": "AddSkip",
                  "fields": [out.length]
                }
              ]],
            }
          ));
        }
      }
      return false;
    }
    if (e.keyCode == 8) {
      if (e.shiftKey) {
        // Delete group while saving contents.
        if (isBlock(active)) {
          clearActive();
          clearTarget();

          op(delto(active,
            {
              "variant": "DelGroup",
              "fields": [[]],
            }
          ), []);

          var first = active.children().first();
          var last = active.children().last();
          if (active.contents().length) {
            active.contents().unwrap();
          } else {
            active.remove();
          }
          active = first.addClass('active')[0] ? first : null;
          last.addClass('target');
        }
      } else if (e.metaKey) {
        // Delete whole block.
        if (isBlock(active)) {
          op(delto(active,
            {
              "variant": "DelGroupAll",
              "fields": [],
            }
          ), []);

          active.remove();
          active = null;
          clearActive();
          clearTarget();
        }
      } else {
        if (isChar(active)) {
          clearActive();
          clearTarget();

          op(delto(active,
            {
              "variant": "DelChars",
              "fields": [1],
            }
          ), []);

          var prev = active.prev();
          var dad = active.parent();
          active.remove();
          active = prev[0] ? prev : dad[0] ? dad : null;
          active.addClass('active').addClass('target');
        }
      }
      return false;
    }
  })

  return ophistory;
}

var m1 = $('#mote-1');
var m2 = $('#mote-2');

var ops_a = init(m1);
var ops_b = init(m2);

$.get('/api/hello', function (data) {
  m1.empty().append(load(data));
  m2.empty().append(load(data));
})

$('#sync').on('click', function () {
  var packet = [
    ops_a,
    ops_b
  ];

  console.log('PACKET', packet)
  
  $.ajax('/api/sync', {
    data : JSON.stringify(packet),
    contentType : 'application/json',
    type : 'POST',
  })
  .done(function () {
    console.log('success', arguments);
  })
  .fail(function () {
    console.log('failure', arguments);
  });
})

</script>
